<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing Results - KrimeWatch</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <header class="text-center py-4 mb-4">
            <h1 class="display-5 mb-2">
                <i class="fas fa-video text-primary me-3"></i>
                KrimeWatch Results
            </h1>
            <p class="lead">Video Analysis Complete</p>
        </header>

        <div class="row">
            <div class="col-lg-10 mx-auto">
                <!-- Processing Status -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-file-video me-2"></i>
                            {{ video.original_filename }}
                        </h4>
                        <div id="statusBadge">
                            {% if video.status == 'completed' %}
                                <span class="badge bg-success fs-6">
                                    <i class="fas fa-check-circle me-1"></i>Processing Complete
                                </span>
                            {% elif video.status == 'processing' %}
                                <span class="badge bg-warning fs-6">
                                    <i class="fas fa-spinner fa-spin me-1"></i>Processing...
                                </span>
                            {% elif video.status == 'inappropriate' %}
                                <span class="badge bg-danger fs-6">
                                    <i class="fas fa-ban me-1"></i>Inappropriate Content
                                </span>
                            {% elif video.status == 'failed' %}
                                <span class="badge bg-danger fs-6">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Processing Failed
                                </span>
                            {% else %}
                                <span class="badge bg-secondary fs-6">
                                    <i class="fas fa-clock me-1"></i>{{ video.status|title }}
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Video Information:</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Upload Time:</strong> {{ video.upload_timestamp.strftime('%Y-%m-%d %H:%M:%S UTC') }}</li>
                                    <li><strong>Duration:</strong> 
                                        {% if video.duration %}
                                            {{ "%.1f"|format(video.duration) }} seconds
                                        {% else %}
                                            Processing...
                                        {% endif %}
                                    </li>
                                    <li><strong>File Size:</strong> {{ "%.1f"|format(video.file_size / 1024 / 1024) }} MB</li>
                                    {% if video.width and video.height %}
                                        <li><strong>Resolution:</strong> {{ video.width }}x{{ video.height }}</li>
                                    {% endif %}
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Processing Status:</h6>
                                <div id="processingInfo">
                                    {% if video.status == 'processing' %}
                                        <div class="alert alert-info">
                                            <i class="fas fa-spinner fa-spin me-2"></i>
                                            Your video is being processed through our AI pipeline. This page will update automatically.
                                        </div>
                                    {% elif video.status == 'inappropriate' %}
                                        <div class="alert alert-danger">
                                            <i class="fas fa-ban me-2"></i>
                                            This video has been flagged as inappropriate content. Multiple violations may result in account restrictions.
                                        </div>
                                    {% elif video.status == 'failed' %}
                                        <div class="alert alert-danger">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            Processing failed. Please try uploading again or contact support.
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Classification Results -->
                {% if video.status == 'completed' and video.classification %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-brain text-warning me-2"></i>
                            AI Classification Results
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="me-4">
                                        <h5 class="mb-1">Category:</h5>
                                        <span class="badge 
                                            {% if video.classification in ['theft', 'burglary', 'robbery', 'assault', 'weapon_detected'] %}bg-danger
                                            {% elif video.classification == 'vehicle_crime' %}bg-warning
                                            {% elif video.classification in ['vandalism', 'drug_activity'] %}bg-warning
                                            {% elif video.classification == 'crowd_disturbance' %}bg-info
                                            {% elif video.classification == 'suspicious_activity' %}bg-secondary
                                            {% elif video.classification == 'traffic_violation' %}bg-primary
                                            {% elif video.classification == 'no_crime' %}bg-success
                                            {% else %}bg-secondary
                                            {% endif %} fs-6">
                                            {{ video.classification.replace('_', ' ')|title }}
                                        </span>
                                    </div>
                                    <div>
                                        <h5 class="mb-1">Confidence:</h5>
                                        <div class="progress" style="width: 150px;">
                                            <div class="progress-bar 
                                                {% if video.confidence_score >= 0.8 %}bg-success
                                                {% elif video.confidence_score >= 0.6 %}bg-warning
                                                {% else %}bg-danger
                                                {% endif %}" 
                                                role="progressbar" 
                                                style="width: {{ (video.confidence_score * 100)|round }}%">
                                                {{ (video.confidence_score * 100)|round }}%
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {% if video.detected_people_count %}
                                <div class="mb-3">
                                    <h6><i class="fas fa-users me-2"></i>People Detected:</h6>
                                    <span class="badge bg-info">{{ video.detected_people_count }} person(s)</span>
                                </div>
                                {% endif %}

                                {% if video.detected_objects %}
                                <div class="mb-3">
                                    <h6><i class="fas fa-eye me-2"></i>Objects Detected:</h6>
                                    <div class="d-flex flex-wrap gap-2">
                                        {% for object, count in (video.detected_objects|from_json).items() %}
                                            <span class="badge bg-secondary">{{ object }}: {{ count }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Multiple Classifications Section -->
                                {% set multiple_classifications = video.multiple_classifications|from_json if video.multiple_classifications else [] %}
                                {% if multiple_classifications %}
                                <div class="mb-3">
                                    <h6><i class="fas fa-list-check me-2"></i>All Detected Crime Types:</h6>
                                    <div class="d-flex flex-wrap gap-2">
                                        {% for classification in multiple_classifications %}
                                            <span class="badge 
                                                {% if classification.type in ['shooting', 'kidnapping', 'robbery', 'assault', 'weapon_detected'] %}bg-danger
                                                {% elif classification.type in ['theft', 'burglary'] %}bg-warning
                                                {% elif classification.type == 'vehicle_crime' %}bg-info
                                                {% elif classification.type in ['vandalism', 'drug_activity'] %}bg-secondary
                                                {% else %}bg-light text-dark
                                                {% endif %}">
                                                {{ classification.type.replace('_', ' ')|title }} ({{ (classification.confidence * 100)|round }}%)
                                            </span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                {% if video.classification in ['shooting', 'kidnapping'] %}
                                <div class="alert alert-danger border-danger">
                                    <h6><i class="fas fa-exclamation-triangle me-2"></i>CRITICAL EMERGENCY</h6>
                                    <p class="mb-0">IMMEDIATE police response dispatched. Emergency services activated.</p>
                                </div>
                                {% elif video.classification in ['theft', 'burglary', 'robbery', 'assault', 'weapon_detected'] %}
                                <div class="alert alert-danger">
                                    <h6><i class="fas fa-exclamation-triangle me-2"></i>URGENT CRIME</h6>
                                    <p class="mb-0">Police and emergency services have been automatically notified.</p>
                                </div>
                                {% elif video.classification == 'vehicle_crime' %}
                                <div class="alert alert-warning">
                                    <h6><i class="fas fa-car me-2"></i>Vehicle Crime Alert</h6>
                                    <p class="mb-0">Police have been notified of potential vehicle crime.</p>
                                </div>
                                {% elif video.classification in ['vandalism', 'drug_activity'] %}
                                <div class="alert alert-warning">
                                    <h6><i class="fas fa-shield-alt me-2"></i>Crime Alert</h6>
                                    <p class="mb-0">Relevant law enforcement units have been notified.</p>
                                </div>
                                {% elif video.classification == 'crowd_disturbance' %}
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-users me-2"></i>Crowd Alert</h6>
                                    <p class="mb-0">Riot control and patrol units have been notified.</p>
                                </div>
                                {% elif video.classification == 'suspicious_activity' %}
                                <div class="alert alert-secondary">
                                    <h6><i class="fas fa-eye me-2"></i>Surveillance Alert</h6>
                                    <p class="mb-0">Patrol units have been notified for increased surveillance.</p>
                                </div>
                                {% elif video.classification == 'traffic_violation' %}
                                <div class="alert alert-primary">
                                    <h6><i class="fas fa-traffic-light me-2"></i>Traffic Alert</h6>
                                    <p class="mb-0">Traffic enforcement has been notified.</p>
                                </div>
                                {% elif video.classification == 'no_crime' %}
                                <div class="alert alert-success">
                                    <h6><i class="fas fa-check-circle me-2"></i>Safe Content</h6>
                                    <p class="mb-0">No criminal activity detected in this video.</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Duplicate Detection Results -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-copy text-info me-2"></i>
                            Duplicate Detection Results
                        </h4>
                    </div>
                    <div class="card-body">
                        {% if video.is_duplicate %}
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-exclamation-circle me-2"></i>Duplicate Detected</h6>
                                <p class="mb-2">This video is similar to previously uploaded content.</p>
                                {% if canonical_video %}
                                    <p class="mb-0">
                                        <strong>Original Video:</strong> 
                                        {{ canonical_video.original_filename }} 
                                        (uploaded {{ canonical_video.upload_timestamp.strftime('%Y-%m-%d %H:%M:%S') }})
                                    </p>
                                {% endif %}
                            </div>
                        {% else %}
                            {% set duplicate_log = logs|selectattr('step', 'equalto', 'duplicate_detection')|first %}
                            {% if duplicate_log and 'duplicate(s)' in duplicate_log.message and not 'No duplicates' in duplicate_log.message %}
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-copy me-2"></i>Duplicates Found</h6>
                                <p class="mb-0">{{ duplicate_log.message }}. This video was selected as the canonical version (best quality).</p>
                            </div>
                            {% else %}
                            <div class="alert alert-success">
                                <h6><i class="fas fa-check-circle me-2"></i>Original Content</h6>
                                <p class="mb-0">This video is unique and has been marked as the canonical version.</p>
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>

                <!-- Processing Log -->
                {% if logs %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-list-alt text-secondary me-2"></i>
                            Processing Log
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="timeline">
                            {% for log in logs %}
                            <div class="timeline-item">
                                <div class="d-flex">
                                    <div class="flex-shrink-0">
                                        <span class="badge 
                                            {% if log.status == 'completed' %}bg-success
                                            {% elif log.status == 'failed' %}bg-danger
                                            {% elif log.status == 'started' %}bg-info
                                            {% else %}bg-secondary
                                            {% endif %}">
                                            {% if log.status == 'completed' %}
                                                <i class="fas fa-check"></i>
                                            {% elif log.status == 'failed' %}
                                                <i class="fas fa-times"></i>
                                            {% elif log.status == 'started' %}
                                                <i class="fas fa-play"></i>
                                            {% else %}
                                                <i class="fas fa-clock"></i>
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-1">{{ log.step.replace('_', ' ')|title }}</h6>
                                        <p class="mb-1">{{ log.message }}</p>
                                        <small class="text-muted">
                                            {{ log.timestamp.strftime('%H:%M:%S') }}
                                            {% if log.processing_time %}
                                                ({{ "%.2f"|format(log.processing_time) }}s)
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Actions -->
                <div class="card">
                    <div class="card-body text-center">
                        <a href="{{ url_for('index') }}" class="btn btn-primary">
                            <i class="fas fa-upload me-2"></i>
                            Upload Another Video
                        </a>
                        {% if video.status == 'failed' %}
                        <button class="btn btn-secondary ms-2" onclick="location.reload()">
                            <i class="fas fa-redo me-2"></i>
                            Retry Processing
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-refresh if video is still processing
        {% if video.status == 'processing' %}
        function checkStatus() {
            fetch('/api/video/{{ video.id }}/status')
                .then(response => response.json())
                .then(data => {
                    if (data.status !== 'processing') {
                        location.reload();
                    }
                })
                .catch(error => console.log('Status check failed:', error));
        }
        
        // Check status every 5 seconds
        setInterval(checkStatus, 5000);
        {% endif %}

        // Custom filter for JSON parsing
        const filters = {
            from_json: function(value) {
                try {
                    return JSON.parse(value || '{}');
                } catch {
                    return {};
                }
            }
        };
    </script>
</body>
</html>
